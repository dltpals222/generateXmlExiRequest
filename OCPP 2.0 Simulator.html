<html>
	<head>
	<title>ChargePoint Simulator</title>
		<style>
			body {
				background: #000;
				color: white;
			}
			
			button,
			input,
			select { 
				display: block;
				width: 100%;
				margin-bottom: 5px;
				cursor: pointer;
			}
			
			button {
				background: #369;
				color: #fff;
				padding: 5px 0;
				border: none;
			}

			button:active {
				margin-left:3px;
				margin-top:3px;
				box-shadow:none;
			}
			
			ul {
				background: #000;
				color: #eee;
			}
			
			li {}
			
			#red,
			#green,
			#blue {
				min-width: 10px;
			}
			
			#red {
				background-color: red;
			}
			
			#green {
				background-color: green;
			}
			
			#blue {
				background-color: blue;
			}
			
			#yellow {
				background-color: yellow;
			}
			
			table,
			th,
			tr,
			td {
				border: 1px solid white;
			}
			
			table {
				margin: auto;
			}
			
			form {
				padding-top: 20px;
			}
			
			.center {
				text-align: center;
			}
		</style>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/forge/0.10.0/forge.min.js"></script>
	</head>
	<body>
		<!-- <select>
			<option value="">
				OCPP-J2.0
			</option>
		</select> -->
		<!-- <input id="CP" type="text" placeholder="ChargePoint ID" value="ws://localhost:100/lw/websocket/CentralSystemService/충전기5_2_지하2층" /> -->
		<label>Central Station</label>
		<select id="CP">
			<option value="0">ws://localhost:200/lw/websocket/CentralSystemService/</option>
			<option value="1">ws://sk-csms.mipllab.com/lw/websocket/CentralSystemService/</option>
			<option value="2">ws://ocpps.mipllab.com:9442/lw/websocket/CentralSystemService/</option>
			<option value="3">ws://ocpp201.skeleclink.net:1200/sk/</option>
			
			<!-- <option value="3">ws://localhost:200/sk/</option> -->
		</select>
		<!-- <label>ChargeBox Name(ID)</label><input id="CP_NAME" type="text" value="충전기5_2_지하2층"/> -->
		<label>ChargeBox Name(ID)</label>
		<!-- <input id="CP_NAME" type="text" value="OCPP2_Tester"/>		 -->
		<select id="CP_NAME">
			<!--
			<option value="4127003801">4127003801</option>
			<option value="4127003802">4127003802</option>
			<option value="OCPP2_Tester">OCPP2_Tester</option>
			<option value="충전기5_2_지하2층">충전기5_2_지하2층</option>
			<option value="Bion_1">Bion_1</option>
			<option value="signet_완속">signet_완속</option>
			<option value="transTest1">transTest1</option>
			<option value="bion-cs-2">bion-cs-2</option>
			<option value="cjjfei12">cjjfei12</option>
			<option value="test-trans-1">test-trans-1</option>
			<option value="Bion-1">Bion-1</option>
			<option value="Bion-2">Bion-2</option>
			-->
			<option value="4127003801">4127003801</option>
			<option value="4127003802">4127003802</option>
			<option value="4127003803">4127003803</option>
			<option value="4127003804">4127003804</option>
			<option value="4127003805">4127003805</option>
			<option value="4127003806">4127003806</option>
			<option value="4127003807">4127003807</option>
			<option value="4127003808">4127003808</option>
			<option value="4127003809">4127003809</option>
			<option value="41270038010">41270038010</option>
			<option value="41270038011">41270038011</option>
			<option value="41270038012">41270038012</option>
			<option value="41270038013">41270038013</option>
			<option value="41270038014">41270038014</option>
			<option value="41270038015">41270038015</option>
			<option value="OCPP2_Tester">OCPP2_Tester</option>
			<option value="충전기5_2_지하2층">충전기5_2_지하2층</option>
			<option value="Bion_1">Bion_1</option>
			<option value="signet_완속">signet_완속</option>
			<option value="transTest1">transTest1</option>
			<option value="bion-cs-2">bion-cs-2</option>
			<option value="test-trans-1">test-trans-1</option>
			<option value="Bion-1">Bion-1</option>
			<option value="Bion-2">Bion-2</option>
			<option value="line201-1">line201-1</option>
			<option value="op1-3">op1-3</option>
			<option value="op3-1">op3-1</option>

			<option value="cjjfei12">cjjfei12</option>
			<option value="hoper5_Test1">hoper5_Test1</option>
			<option value="reModify-666">reModify-666</option>

			<option value="test_cb2">test_cb2</option>			

			<option value="oca-cs1">oca-cs1</option>			
			<option value="oca-cs11">oca-cs11</option>			

		</select>
		<label>Tag</label>
		<select id="TAG">
			<option value="E0040100019DA1">E0040100019DA1</option>
			<option value="E0040100019DA2">E0040100019DA2</option>
			<option value="E0040100019DA3">E0040100019DA3 (POC)</option>
			<option value="1621045032539">1621045032539</option>
			<option value="123456789">123456789 ( Unknown IdToken )</option>
			<option value="FEDCBA98765432">FEDCBA98765432 ( Master Pass )</option>
			<option value="77777771819">77777771819 ( sm_busi )</option>
			<option value="7770809">7770809 ( sm_busi )</option>
			<option value="1234968976204">1234968976204(2347)</option>
			<option value="338406338976">338406338976(2362 - n)</option>

			<option value="202020">202020</option>
			
		</select>
		<label>Tag Type</label>
		<select id="TAG_TYPE">
			<option value="ISO14443">ISO14443</option>
			<option value="ISO15693">ISO15693</option>
			<option value="KeyCode">KeyCode</option>
			<option value="Central">Central</option>
			<option value="eMAID">eMAID</option>
			<option value="Local">Local</option>
			<option value="MacAddress">MacAddress</option>
			<option value="NoAuthorization">NoAuthorization</option>
		</select>
		<button id="connect">Connect</button>
		<button id="send">Authorize</button>
		<button id="start">Start Transaction - EVConnected</button>
		<button id="update">Update Transaction - EVDetected</button>
		<button id="update_suspendedevse">Update Transaction - SuspendedEVSE</button>
		<button id="update_suspendedev">Update Transaction - SuspendedEV</button>
		<button id="update_charging">Update Transaction - Charging</button>
		<button id="stop">Stop Transaction</button>
		<button id="heartbeat">Heartbeat</button>
		<button id="mv">Meter Values</button>

		<label>Status Notification</label>
		<select id="status_noti_opt">
			<option value="Available">Available</option>
			<option value="Occupied">Occupied</option>
			<option value="Reserved">Reserved</option>
			<option value="Unavailable">Unavailable</option>
			<option value="Faulted">Faulted</option>
		</select>
		<label>EVSE Id</label><input id="evse_id" type="number" value="1">
		<label>Connector Id</label><input id="conn_id" type="number" value="1">
		<button id="status">Status Notification</button>
		<button id="data_transfer">Data Tranfer</button>
		<button id="firmwarestatus">Firmware Status Notification</button>
		<button id="clearedChargingLimit">Cleared Charging Limit</button>
		<button id="logstatus_uploading">LogStatus Notification - Uploading</button>
		<button id="logstatus_uploaded">LogStatus Notification - Uploaded</button>
		<button id="notify_charging_limit">Notify Charging Limit - 10 A</button>
		<button id="notify_charging_needs">Notify Charging Needs</button>
		<button id="notify_ev_charging_schedule">Notify EV Charging Schedule - 10 A</button>
		<button id="security_event_notification">Security Event Notification</button>
		<label for="input-csr">CSR 파일</label><input type="file" id="input-csr">

		<label>CSR Certificate Type</label>
		<select id="cert_type">
			<option value="ChargingStationCertificate">ChargingStationCertificate</option>
			<option value="V2GCertificate">V2GCertificate</option>
		</select>
		<button id="signCert">Sign Certificate</button>

		

		<button id="getCC">Get15118 EV Certificate</button>

		<button id="GetCertificateStatus">GetCertificateStatus</button>
		<label for="issuerNameHash">Issuer Name Hash</label>
		<input type="text" id="issuerNameHash" placeholder="Enter Issuer Name Hash">

		<label for="issuerKeyHash">Issuer Key Hash</label>
		<input type="text" id="issuerKeyHash" placeholder="Enter Issuer Key Hash">

		<label for="serialNumber">Serial Number</label>
		<input type="text" id="serialNumber" placeholder="Enter Serial Number">

		<label for="responderURL">Responder URL</label>
		<input type="text" id="responderURL" placeholder="Enter Responder URL">

		<label for="hashAlgorithm">Hash Algorithm</label>
		<select id="hashAlgorithm">
			<option value="SHA256">SHA256</option>
			<option value="SHA384">SHA384</option>
			<option value="SHA512">SHA512</option>
		</select>
		
		<button id="clear_msg">Clear Log Message</button>


		<div>
			<span class="indicator" id="red">____</span>
			<span class="indicator" id="green">____</span>
			<span class="indicator" id="blue">____</span>
			<span class="indicator" id="yellow">____</span>
		</div>
		<ul id="console"></ul>
		<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
		<script>
			$('.indicator').hide();
			$('#red').show();

			function formatDate(date) {

				var day = String(date.getDate());
				if (day.length < 2) {
					day = ('0' + day.slice(-2));
				}

				var monthIndex = String(date.getMonth() + 1);
				if (monthIndex.length < 2) {
					monthIndex = ('0' + monthIndex.slice(-2));
				}
				var year = date.getFullYear();
				var h = date.getHours();
				if (h < 3) {
					h = 24 - h;
				}
				h = String(h - 1);
				if (h.length < 2) {
					h = ('0' + h.slice(-2));
				}
				var m = String(date.getMinutes());

				var s = String(date.getSeconds());
				if (m.length < 2) {
					m = ('0' + m.slice(-2));
				}
				if (s.length < 2) {
					s = ('0' + s.slice(-2));
				}
				// return year + '-' + monthIndex + '-' + day + "T" + h + ":" + m + ":" + s + "Z";

				return new Date().toISOString();
			}

			function saveCertificateToPemFile(certData, certName = 'cmp-client-cert.pem') {
				// let decoded = atob(certData);
				const blob = new Blob([certData], { type: 'application/octet-stream' });
				// const blob = new Blob([decoded], { type: 'application/octet-stream' });
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = certName
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
				URL.revokeObjectURL(url);
			}

			var c = 0;
			var start_id = "";
			var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
			var id = randomId();
			var lastTranId;
			var _websocket = null;

			var connector_locked = false;

			var interval;
			var meterVal = 0;
			var soc = 0;
			
			var remoteStartId = 0;
			
			var seqNo = 0;

			let msgIdStorage = new Map();

			function initVariables() {
				meterVal = 0;
				soc = 0;
				remoteStartId = 0;
				seqNo = 0;
			}

			function randomId() {
				id = "";
				for (var i = 0; i < 36; i++) {
					id += possible.charAt(Math.floor(Math.random() * possible.length));
				}
				return id;
			}

			function guid() {
				function s4() {
					return Math.floor((1 + Math.random()) * 0x10000)
						.toString(16)
						.substring(1);
					}
				return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
			}

			let cnt = 0;
			function wsConnect() {

				var wsurl = $('select').val();
				var CP = $('#CP').val();
				var CP_NAME = $('#CP_NAME option:selected').val();

				if(CP == 0) {
					CP = 'ws://localhost:200/lw/websocket/CentralSystemService/'
				} else if(CP == 1) {
					CP = 'ws://sk-csms.mipllab.com:9442/lw/websocket/CentralSystemService/'
				} else if(CP == 2) {
					CP = 'ws://ocpps.mipllab.com:9442/lw/websocket/CentralSystemService/'
				} else if(CP == 3) {
					CP = 'ws://ocpp201.skeleclink.net:1200/sk/'
				} 

				if (_websocket) {
					$('#red').show();
					_websocket.close(3001);
				} else {
					//_websocket = new WebSocket(wsurl + "" + CP, "ocpp2.0.1");
					_websocket = new WebSocket(CP + CP_NAME, "ocpp2.0.1");
					
					_websocket.onopen = function(authorizationData) {

						sessionStorage.setItem('LastAction', "BootNotification");
						$('#yellow').show();
						BootNotification();

						$('#connect').text('Disconnect').css('background', 'green');

					};

					_websocket.onmessage = function(msg) {
						c++;
						var ddata = (JSON.parse(msg.data));

						if (c == 1) {
							var hb_interval = handleData(ddata);
							//sessionStorage.setItem("Confriguration", hb_interval);
							// startHB(hb_interval * 1000);
							// startHB(3 * 1000);
						}

						if (ddata[0] === 3) {
							la = getLastAction();

							
							logMsg("=================================================");
							logMsg("Message Type : " + ddata[0] + " (CALL_RESULT)"); 
							logMsg("ID : " + ddata[1]);
							logMsg("Data : " + JSON.stringify(ddata[2]));
							logMsg("Last Action : " + getLastAction() + " is succeeded");
							logMsg("=================================================");
							

							/*
							if(la == "Heartbeat") {
								if(cnt == 0) console.log('start : ', new Date())

								if(cnt >= 999) console.log('end : ', new Date()) 
							}
							*/
							

							if (la == "startTransaction") {

								ddata = ddata[2];
								logMsg("Data exchange successful!");
								var array = $.map(ddata, function(value, index) {
									return [value];
								});
								var TransactionId = (array[0]);
								sessionStorage.setItem('TransactionId', TransactionId);
							} else if(la == "DataTransfer") {
								saveCertificateToPemFile(ddata[2].data, 'trusted-ca.pem')
							}

							logMsg("Response recieved successfully!");


							/*
							let sentMsgId = getSavedMsgId(la);

							if(sentMsgId != ddata[1]) {
								console.error('action : ', la)
								console.error('diff id / sentMsgId: ', sentMsgId, ' recv Id : ', ddata[1])
							}
							*/

						} else if ((JSON.parse(msg.data))[0] === 4) {
							logMsg("Data exchange failed - JSON is not accepted!");
							logMsg("----------------------------------------------------");
							logMsg("Message Type : " + " (CALL_ERROR)"); 
							logMsg("ID : " + ddata[1]);
							logMsg("Error Code : " + ddata[2]);
							logMsg("Error Description : " + ddata[3]);
							logMsg("Error Details : " + ddata[4]);
							logMsg("----------------------------------------------------");  
						} else if ((JSON.parse(msg.data))[0] === 2) {
							logMsg((JSON.parse(msg.data))[2]);
							id = (JSON.parse(msg.data))[1];
							

							
							logMsg("----------------------------------------------------");
							logMsg("Message Type : " + ddata[0] + " (CALL)"); 
							logMsg("ID : " + ddata[1]);
							logMsg("Action Message From Server : " + "[ " + ddata[2] + " ]");
							logMsg("Data : " + JSON.stringify(ddata[3]));
							logMsg("----------------------------------------------------");
							

							switch (ddata[2]) {
								case "ChangeAvailability":
									var changeAvail = JSON.stringify([3, id, {
										"status": "Accepted"
									}]);
									_websocket.send(changeAvail);
									break;
								case "SetVariables":
									var setVar = JSON.stringify([3, id, {
										"setVariableResult": [{
											"attributeStatus": "Accepted",
											"component": {
												"name": "SecurityCtrlr"
											},
											"variable": {
												"name": "BasicAuthPassword"
											}


											/*
											"attributeStatus": "Accepted",
											"component": {
												"name": "OCPPCommCtrlr"
											},
											"variable": {
												"name": "ResetRetries"
											}
											*/

										}]
									}]);
									_websocket.send(setVar);
									break;
								case "ClearCache":
									var clearCache = JSON.stringify([3, id, {
										"status": "Accepted"
									}]);
									_websocket.send(clearCache);
									break;
								case "GetLog":
									var getLog = JSON.stringify([3, id, {
										"status": "Accepted",
										"filename": "somefile.txt"
									}]);
									_websocket.send(getLog);
									break;
								case "RequestStartTransaction":
									let remoteData = ddata[3];
									let remoteStartId = remoteData?.remoteStartId;
									let idToken = remoteData.idToken.idToken;

									var reqStartTrans = JSON.stringify([3, id, {
										"status": "Accepted"
									}]);
									_websocket.send(reqStartTrans);
									// Authorize(idToken);
									// startTransactionByRemote("Charging", null, remoteStartId, idToken);
									break;
								case "RequestStopTransaction":
									//remoteStartId = 0;
									var reqStopTrans = JSON.stringify([3, id, {
										"status": "Accepted"
									}]);
									_websocket.send(reqStopTrans);

									var stop_id = (JSON.parse(msg.data)[3].transactionId);
									// stopTransaction(stop_id);
									break;
								case "Reset":
									var ResetS = JSON.stringify([3, id, {
										"status": "Accepted"
									}]);
									_websocket.send(ResetS);
									//location.reload();
									break;
								case "UnlockConnector":
									var unlockCon = JSON.stringify([3, id, {
										"status": "Unlocked"
									}]);
									_websocket.send(unlockCon);
									connector_locked = false;
									$('.indicator').hide();
									$('#yellow').show();
									logMsg("Connector status changed to: " + connector_locked);
									statusNotification();
									break;
								case "UpdateFirmware":
									var updFirm = JSON.stringify([3, id, {
										"status": "Accepted"
									}]);
									_websocket.send(updFirm);
									break;
								case "ReserveNow":
									var resNow = JSON.stringify([3, id, {
										"status": "Accepted"
									}]);
									_websocket.send(resNow);
									break;
								case "CancelReservation":
									var cancelRes = JSON.stringify([3, id, {
										"status": "Accepted"
									}]);
									_websocket.send(cancelRes);
									break;
								case "DataTransfer":
									var dataTrans = JSON.stringify([3, id, {
										"status": "Accepted",
										"data": "some data"
									}]);
									_websocket.send(dataTrans);
									break;
								case "GetVariables":
									var payload = { getVariableResult: [] };

									let recv = ddata[3];
									let len = recv.getVariableData.length;
									

									for(let i = 0 ; i < len ; i++) {
										let ele = recv.getVariableData[i];
										let gc = {variable:null, component:null};

										gc.component = { name: ele.component.name };
										gc.variable = { name: ele.variable.name };


										if(ele.component.name == 'DeviceDataCtrlr') {
											if(ele.variable.name == 'SampledDataAvailable') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 'true';
											} else if(ele.variable.name == 'AlignedDataInterval') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 360;
											} else if(ele.variable.name == 'RestartDelay') {
												gc.attributeStatus = 'UnknownVariable';
												gc.attributeValue = 10;
											} else if(ele.variable.name == 'ItemsPerMessage') {
												if(ele.variable.hasOwnProperty('instance')) {
													if(ele.variable.instance == 'GetReport') {
														gc.attributeStatus = 'Accepted';
														gc.attributeValue = 5;
														gc.variable['instance'] = ele.variable.instance;
													} else if(ele.variable.instance == 'GetVariables') {
														gc.attributeStatus = 'Accepted';
														gc.attributeValue = '10a';
														gc.variable['instance'] = ele.variable.instance;
													} else if(ele.variable.instance == 'SetVariables') {
														gc.attributeStatus = 'Accepted';
														gc.attributeValue = 10;
														gc.variable['instance'] = ele.variable.instance;
													} else {
														continue;
													}
												}
											} else if(ele.variable.name == 'BytesPerMessage') {
												if(ele.variable.hasOwnProperty('instance')) {
													if(ele.variable.instance == 'GetReport') {
														gc.attributeStatus = 'Accepted';
														gc.attributeValue = 300;
													} else if(ele.variable.instance == 'GetVariables') {
														gc.attributeStatus = 'Accepted';
														gc.attributeValue = 300;
														gc.variable['instance'] = ele.variable.instance;
													} else if(ele.variable.instance == 'SetVariables') {
														gc.attributeStatus = 'Accepted';
														gc.attributeValue = 300;
														gc.variable['instance'] = ele.variable.instance;
													}
												}
											} else if(ele.variable.name == 'ConfigurationValueSize') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 1000;
											} else if(ele.variable.name == 'ReportingValueSize') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 2500;
											} else {
												continue;
											}
										} else if(ele.component.name == 'ReservationCtrlr') {
											if(ele.variable.name == 'NonEvseSpecific') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = true;
											} else if(ele.variable.name == 'Available') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = true;
											} else {
												continue;
											}
										} else if(ele.component.name == 'AuthCtrlr') {
											if(ele.variable.name == 'OfflineTxForUnknownIdEnabled') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = true;
											} else if(ele.variable.name == 'MasterPassGroupId') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = "F0040100019DFF123";
											} else {
												continue;
											}
										} else if(ele.component.name == 'TxCtrlr') {
											if(ele.variable.name == 'StopTxOnInvalidId') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = true;
											} else {
												continue;
											}
										} else if(ele.component.name == 'LocalAuthListCtrlr') {
											if(ele.variable.name == 'Enabled') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = true;
											} else if(ele.variable.name == 'Available') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = true;
											} else {
												continue;
											}
										} else if(ele.component.name == 'OCPPCommCtrlr') {
											if(ele.variable.name == 'FileTransferProtocols') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 'FTP';
											} else if(ele.variable.name == 'HeartbeatInterval') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 50;
											} else {
												continue;
											}
										} else if(ele.component.name == 'SmartChargingCtrlr') {
											if(ele.variable.name == 'ProfileStackLevel') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 10;
											} else if(ele.variable.name == 'RateUnit') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 'W,A';
											} else if(ele.variable.name == 'PeriodsPerSchedule') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 3;
											} else if(ele.variable.name == 'Available') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = true;
											} else {
												continue;
											}
										} else if(ele.component.name == 'MonitoringCtrlr') {
											if(ele.variable.name == 'ItemsPerMessage') {
												if(ele.variable.hasOwnProperty('instance')) {
													if(ele.variable.instance == 'SetVariableMonitoring') {
														gc.attributeStatus = 'Accepted';
														gc.attributeValue = 10;
													} else if(ele.variable.instance == 'ClearVariableMonitoring') {
														gc.attributeStatus = 'Accepted';
														gc.attributeValue = 10;
													} else {
														continue;
													}
												} else {
													continue;
												}
											} else if(ele.variable.name == 'BytesPerMessage') {
												if(ele.variable.hasOwnProperty('instance')) {
													if(ele.variable.instance == 'SetVariableMonitoring') {
														gc.attributeStatus = 'Accepted';
														gc.attributeValue = 300;
													} else if(ele.variable.instance == 'ClearVariableMonitoring') {
														gc.attributeStatus = 'Accepted';
														gc.attributeValue = 300;
													} else {
														continue;
													}
												} else {
													continue;
												}
											} else if(ele.variable.name == 'Available') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = true;
											}
											else {
												continue;
											}
										} else if(ele.component.name == 'TxCtrlr') {
											if(ele.variable.name == 'StopTxOnInvalidId') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = true;
											} else {
												continue;
											}

										} else if(ele.component.name == 'LocalAuthListCtrlr') {
											if(ele.variable.name == 'ItemsPerMessage') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 10;
											} else if(ele.variable.name == 'BytesPerMessage') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 300;
											} else if(ele.variable.name == 'Available') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = true;
											} else if(ele.variable.name == 'Enabled') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = true;
											} else {
												continue;
											}
										} else if(ele.component.name == 'TariffCostCtrlr') {
											if(ele.variable.name == 'Available') {
												if(ele.variable.hasOwnProperty('instance')) {
													if(ele.variable.instance == 'Cost') {
														gc.attributeStatus = 'Accepted';
														gc.attributeValue = false;
													} else {
														continue;
													}
												} else {
													continue;
												}
											}
										} else if(ele.component.name == 'DisplayMessageCtrlr') {
											if(ele.variable.name == 'Available') {
												if(ele.variable.hasOwnProperty('instance')) {
													if(ele.variable.instance == 'ClearVariableMonitoring') {
														gc.attributeStatus = 'Accepted';
														gc.attributeValue = false;
													} else {
														continue;
													}
												} else {
													gc.attributeStatus = 'Accepted';
													gc.attributeValue = false;
												}
											} else if(ele.variable.name == 'DisplayMessages') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 20;
											} else {
												continue;
											}
										} else if(ele.component.name == 'EVSE') {
											if(ele.variable.name == 'Power') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 300;
											} else if(ele.variable.name == 'SupplyPhases') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 3;	// AC : 1 or 3	DC : 0
											} else {
												continue;
											}
										} else if(ele.component.name == 'Connector') {
											if(ele.variable.name == 'ConnectorType') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = "cCCS1,cCCS2,cG105,cTesla,cType1,cType2,s309-1P-16A,s309-1P-32A,s309-3P-16A,s309-3P-32A,sBS1361,sCEE-7-7,sType2,sType3,other1PhMax16A,other1PhOver16A,other3Ph,Pan,wInductive,wResonant,cGBT,cChaoJi,OppCharge"
											} else if(ele.variable.name == 'SupplyPhases') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 3;	// AC : 1 or 3	DC : 0
											} else {
												continue;
											}

										} else if(ele.component.name == 'ChargingStation') {
											if(ele.variable.name == 'SupplyPhases') {
												gc.attributeStatus = 'Accepted';
												gc.attributeValue = 3;	// AC : 1 or 3	DC : 0
											} else {
												continue;
											}
										} else {
											continue;
										}

										payload.getVariableResult.push(gc);
									}

									getVars = JSON.stringify([3, id, payload])
									_websocket.send(getVars);
									break;
								case "GetLocalListVersion":
									var gLocList = JSON.stringify([3, id, {
										"versionNumber": 1
									}]);
									console.log('######### Send Local List Versiooooooooooooooooooon')
									_websocket.send(gLocList);
									break;
								case "SendLocalList":
									var sendLocList = JSON.stringify([3, id, {
										"status": "VersionMismatch"
									}]);
									_websocket.send(sendLocList);
									break;
								case "TriggerMessage":
									var triggerMsg = JSON.stringify([3, id, {
										"status": "Accepted"
									}]);
									_websocket.send(triggerMsg);

									var req_message = (JSON.parse(msg.data)[3].requestedMessage);
									if (req_message == "BootNotification") {
										BootNotification();
									}
									if (req_message == "LogStatusNotification") {}
									if (req_message == "FirmwareStatusNotification") {
										FirmwareStatusNotification();
									}
									if (req_message == "Heartbeat") {
										send_heartbeat();
									}
									if (req_message == "MeterValues") {
										meterValues();
									}
									if (req_message == "SignChargingStationCertificate") {}
									if (req_message == "SignV2GCertificate") {}
									if (req_message == "StatusNotification") {
										statusNotification();
									}
									if (req_message == "TransactionEvent") {}
									break;
								case "GetCompositeSchedule":
									var getComp = JSON.stringify([3, id, {
										"status": "Rejected",
										"schedule": {
											"evseId": 123,
											"duration": 52235682,
											"scheduleStart": "1959-02-28T19:30:08.0Z",
											"chargingRateUnit": "W",
											"chargingSchedulePeriod": [
												{
													"startPeriod": 123,
													"limit": 3221,
													"phaseToUse": 1,
													"numberPhases": 3
												},
												{
													"startPeriod": 456,
													"limit": 623,
													"numberPhases": 2,
													"phaseToUse": 3
												},
												{
													"startPeriod": 789,
													"limit": 442,
													"phaseToUse": 3
												}
											],
											"customData": {
											"vendorId": "labore cupidatat quis"
											}
										},
										"statusInfo": {
											"reasonCode": "adipisicing pa",
											"additionalInfo": "veniam sint exercitation ea ut"
										}
									}]);
									_websocket.send(getComp);
									break;
								case "ClearChargingProfile":
									var clearChargPrfl = JSON.stringify([3, id, {
										"status": "Accepted"
									}]);
									_websocket.send(clearChargPrfl);
									break;
								case "SetChargingProfile":
									var setChargPrlf = JSON.stringify([3, id, {
										"status": "Accepted"
									}]);
									_websocket.send(setChargPrlf);
									break;
								case "CertificateSigned":
									var certSigned = JSON.stringify([3, id, {
										"status": "Accepted"
									}]);

									_websocket.send(certSigned);

									let csrSigned = ddata[3];


									if(csrSigned?.certificateChain) {
										saveCertificateToPemFile(csrSigned.certificateChain)
									}


									break;
								case "ClearDisplayMessage":
									var clearDispMsg = JSON.stringify([3, id, {
										"status": "Accepted"
									}]);
									_websocket.send(clearDispMsg);
									break;
								case "ClearVariableMonitoring":
									var clearVarMon = JSON.stringify([3, id, {
										"clearMonitoringResult": [{
											"id": 1,
											"status": "Accepted"
										}, {
											"id": 2,
											"status": "Rejected"
										}, {
											"id": 3,
											"status": "NotFound"
										}]
									}]);
									_websocket.send(clearVarMon);
									break;
								case "GetBaseReport":
									var getBaseRep = JSON.stringify([3, id, {
										"status": "Accepted"
									}]);
									_websocket.send(getBaseRep);
									break;
								case "CostUpdated":
									var costUpdtd = JSON.stringify([3, id, {}]);
									_websocket.send(costUpdtd);
									break;
								case "GetMonitoringReport":
									var getMonRep = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(getMonRep);
									break;
								case "GetReport":
									var getRep = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(getRep);
									break;
								case "SetMonitoringBase":
									var setMonBase = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(setMonBase);
									break;
								case "SetMonitoringLevel":
									var setMonLevel = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(setMonLevel);
									break;
								case "SetVariableMonitoring":
									var setVarMon = JSON.stringify([3, id, {"setMonitoringResult": [{
										"id": 1,
										"type": "Periodic",
										"severity": 9,
										"status": "Accepted",
										"component": {
											"name": "some component"
											},
										"variable":{
											"name": "some variable"
											}
									}]}]);
									_websocket.send(setVarMon);
									break;
								case "UnpublishFirmware":
									var unpFirm = JSON.stringify([3, id, {"status": "Unpublished"}]);
									_websocket.send(unpFirm);
									break;
								case "CustomerInformation":
									var custmrInfo = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(custmrInfo);
									break;
								case "SetDisplayMessage":
									var setmessage = (JSON.parse(msg.data)[3].message.message.content);
									logMsg("Display message: <b><i>" + setmessage + "</i></b>");
									var setDispMsg = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(setDispMsg);
									break;
								case "DeleteCertificate":
									var delCert = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(delCert);
									break;
								case "GetChargingProfiles":
									var getChargPrfl = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(getChargPrfl);
									break;
								case "GetDisplayMessages":
									var getDispMsg = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(getDispMsg);
									break;
								case "GetInstalledCertificateIds":
									var getInstalledCertIds = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(getInstalledCertIds);
									break;
								case "GetTransactionStatus":
									var getTranStat = JSON.stringify([3, id, {"messagesInQueue": "true"}]);
									_websocket.send(getTranStat);
									break;
								case "InstallCertificate":
									var installCert = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(installCert);
									break;
								case "NotifyCentralChargingNeeds":
									var noCentChargNeed = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(noCentChargNeed);
									break;
								case "PublishFirmware":
									var pubFirmware = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(pubFirmware);
									break;
								case "Renegotiate15118Schedule":
									var renSchedule = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(renSchedule);
									break;
								case "SetNetworkProfile":
									var setNetProfl = JSON.stringify([3, id, {"status": "Accepted"}]);
									_websocket.send(setNetProfl);
									break;
								default:
									var error = JSON.stringify([4, id]);
									_websocket.send(error);
									break;
							}
						}
					};

					_websocket.onclose = function(evt) {
						$('#connect').text('Connect').css('background', '#369');
						clearInterval(interval);
						initVariables();
						if (evt.code == 3001) {
							logMsg('ws closed');
							_websocket = null;
						} else {
							logMsg('ws connection error: ' + evt.code);
							$('#console').html("");
							_websocket = null;
							wsConnect();
						}
						//
					};

					_websocket.onerror = function(evt) {
						clearInterval(interval);
						if (_websocket.readyState == 1) {
							$('#red').show();
							logMsg('ws normal error: ' + evt.type);
						}
					};
				}
			}

			function logMsg(err) {
				console.log(err);
				$('#console').append('<li>' + err + '</li>');
			}

			function saveMsgId(action, msgId) {
				msgIdStorage.set(action, msgId);
			}

			function getSavedMsgId(action) {
				return msgIdStorage.get(action);
			}

			function Authorize(id_token = '1010001083593234') {
				let msgId = randomId();

				saveMsgId('Authorize', msgId);

				sessionStorage.setItem('LastAction', "Authorize");
				var Auth = JSON.stringify([2, msgId, "Authorize", {

								//"certificate": "minim",
								// "iso15118CertificateHashData": [
								// 	{
								// 		"hashAlgorithm": "SHA256",
								// 		"issuerNameHash": "b28c94b2195c8ed259f0b415aaee3f39b0b2920a4537611499fa044956917a21",
								// 		"issuerKeyHash": "9d70e29a86e1fcaf066bb1ca7588ccd3fc600bc1064726af141b36cd5a192ae7",
								// 		"serialNumber": "085e8140cc43a5e1",
								// 		"responderURL": "http://www.response.co.kr"
								// 	},
									/*
									
									{
										"hashAlgorithm": "SHA256",
										"issuerNameHash": "b28c94b2195c8ed259f0b415aaee3f39b0b2920a4537611499fa044956917a21",
										"issuerKeyHash": "9d70e29a86e1fcaf066bb1ca7588ccd3fc600bc1064726af141b36cd5a192ae7",
										"serialNumber": "085e8140cc43a5e1",
										"responderURL": "http://www.response.co.kr"
									}
										
									{
										"hashAlgorithm": "SHA256",
										"issuerNameHash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
										"issuerKeyHash": "4ea5c508a6566e76240543f8feb06fd457777be39549c4016436afda65d2330e",
										"serialNumber": "085e8140cc43a5e1",
										"responderURL": "http://www.response.co.kr"
									}

									{
										"hashAlgorithm": "SHA256",
										"issuerNameHash": "xzxklsie3l2lx.akdjkgl",
										"issuerKeyHash": "xowl13l4-ccgr-233rddf-2122",
										"serialNumber": "cjlsi-sjjijizz82j-xli1",
										"responderURL": "http://www.response.co.kr"
									}

									*/

									/*
									{
										"hashAlgorithm": "SHA256",
										"issuerNameHash": "xzxklsie3l2lx.akdjkgl",
										"issuerKeyHash": "xowl13l4-ccgr-233rddf-2122",
										"serialNumber": "cjlsi-sjjijizz82j-xli1",
										"responderURL": "http://www.response.co.kr"
									}
									*/
									
								
								// ] ,
								
								"idToken": 
								{
									
									"idToken": $('#TAG_TYPE option:selected').val() == "NoAuthorization" ? "" : $('#TAG option:selected').val(),
									"type":$('#TAG_TYPE option:selected').val()
									
								}
								
								
						
						}
					]
				);
				_websocket.send(Auth);

			}

			function FirmwareStatusNotification() {
				let msgId = randomId();

				saveMsgId('FirmwareStatusNotification', msgId);

				sessionStorage.setItem('LastAction', "FirmwareStatusNotification");
				var FirmStat = JSON.stringify([2, msgId, "FirmwareStatusNotification", {
					"status": "Installed",
					"requestId": "0"
				}]);
				_websocket.send(FirmStat);

			}

			function startTransactionByRemote(charge_state = "EVConnected", evseId = 1, remoteStartId = null, idToken = null) {
				
				let msgId = randomId();

				saveMsgId('startTransaction', msgId);

				sessionStorage.setItem('LastAction', "startTransaction");
				$('.indicator').hide();
				$('#green').show();
				connector_locked = true;
				meterVal = 0;
				soc = 0;
				seqNo++;
				logMsg("Connector status changed to: " + connector_locked);
				lastTranId = guid();
								
				
				var strtT = JSON.stringify([2, msgId, "TransactionEvent", {
					"eventType": "Started",
					"timestamp": formatDate(new Date()),
					"triggerReason": "CablePluggedIn",
					"seqNo": seqNo,
					"offline": false,

					
					"idToken": {
						"idToken": ("#TAG option:selected").val(),
						// "idToken": (idToken.toUpperCase().includes('NON')) ? "SSC_APP_Non99999" : "1010001083593234",						//"SSC_APP_Non99999", 
						"type": "ISO14443"
					},
					

					"evse": {
						"id": 1, //evseId,
						"connectorId": 1
					},
					"transactionInfo": {
						"transactionId": lastTranId,
						"remoteStartId": remoteStartId,
						"chargingState": charge_state
					},
					
					
					"meterValue": [{
						"timestamp": formatDate(new Date()),
						"sampledValue": [
							{
								"value": 11, // meterVal,
								"context": "Transaction.Begin"
							},
							{
								"value": 22, //soc,
								"context": "Transaction.Begin",
								"measurand": "SoC"
							}
						
						]
					}]
					
					
				}]);
				

				/*
				var strtT = JSON.stringify([2, msgId, "TransactionEvent", {
					"eventType":	"Started",
					"timestamp":	"2024-05-27T15:20:25Z",
					"triggerReason":	"Authorized",
					"seqNo":	1234,
					"transactionInfo":	{
						"transactionId":	"123-123"
					}
				}] );
				*/

				console.log('start val : ', meterVal)
				_websocket.send(strtT);
			}
			
			function startTransaction(charge_state = "EVConnected", evseId = 1) {
				
				let msgId = randomId();

				saveMsgId('startTransaction', msgId);

				sessionStorage.setItem('LastAction', "startTransaction");
				$('.indicator').hide();
				$('#green').show();
				connector_locked = true;
				meterVal = 0;
				soc = 0;
				seqNo++;
				logMsg("Connector status changed to: " + connector_locked);
				lastTranId = guid();
								
				
				var strtT = JSON.stringify([2, msgId, "TransactionEvent", {
					"eventType": "Started",
					"timestamp": formatDate(new Date()),
					"triggerReason": "CablePluggedIn",
					"seqNo": seqNo,
					"offline": false,

					/*
					"idToken": {
						"idToken": "1010001083593234", //$("#TAG option:selected").val(),
						// "idToken": (idToken.toUpperCase().includes('NON')) ? "SSC_APP_Non99999" : "1010001083593234",						//"SSC_APP_Non99999", 
						"type": "ISO14443"
					},
					*/
					"idToken": {
						"idToken": $("#TAG option:selected").val(),
						"type": "ISO14443"
					},

					/*
					"evse": {
						"id": 1, //evseId,
						"connectorId": 1
					},
					*/


					"transactionInfo": {
						"transactionId": lastTranId,
						//"remoteStartId": remoteStartId,
						"chargingState": charge_state
					},
					
					
					"meterValue": [{
						"timestamp": formatDate(new Date()),
						"sampledValue": [
							{
								"value": 11, // meterVal,
								"context": "Transaction.Begin"
							},
							{
								"value": 22, //soc,
								"context": "Transaction.Begin",
								"measurand": "SoC"
							}
						
						]
					}]
					
					
				}]);
				

				/*
				var strtT = JSON.stringify([2, msgId, "TransactionEvent", {
					"eventType":	"Started",
					"timestamp":	"2024-05-27T15:20:25Z",
					"triggerReason":	"Authorized",
					"seqNo":	1234,
					"transactionInfo":	{
						"transactionId":	"123-123"
					}
				}] );
				*/

				console.log('start val : ', meterVal)
				_websocket.send(strtT);
			}

			function updateTransaction(charger_state = "EVDetected", evseId = 1) {
				let msgId = randomId();

				saveMsgId('updateTransaction', msgId);

				sessionStorage.setItem('LastAction', "updateTransaction");
				meterVal += 30;
				soc += 0.5;
				seqNo++;

				console.log("### meterVal : ", meterVal)

				var updTrns = JSON.stringify([2, msgId, "TransactionEvent", {
					"eventType": "Updated",
					"timestamp": formatDate(new Date()),
					"triggerReason": "MeterValuePeriodic",
					"seqNo": seqNo,
					"offline": false,
					
					"idToken": {
						"idToken": $('#TAG option:selected').val(),
						// "idToken":	"SSC_APP_Non99999",
						"type": "ISO14443"
					},
					
					"evse": {
						"id": 1, //evseId,
						"connectorId": 1
					},
					"transactionInfo": {
						"transactionId": lastTranId,
						//"remoteStartId": 0,
						"chargingState": charger_state
					},
					
					"meterValue": [{
						"timestamp": formatDate(new Date()),
						"sampledValue": [
							{
								"value": meterVal,
								//"context": "Sample.Periodic",
								//"measurand": "Energy.Active.Import.Register",
								"phase": "L1",
								"location": "EV",
								//"unitOfMeasure": {
								//	"unit": "Wh"
								//}
							},
							{
								"value": soc,		// 0.5
								"measurand": "SoC",
								"context": "Sample.Periodic"
							},
							{
								"value": 3000,		// 0.5
								"measurand": "Power.Active.Import",
								"context": "Sample.Periodic"
							},
							{
								"value": 3,		// 0.5
								"measurand": "Current.Import",
								"context": "Sample.Periodic"
							}
						
						]
					}]
					


				}]);

				

				let transObj = JSON.parse(updTrns);
				
				_websocket.send(updTrns);
			}

			function stopTransaction(transaction_id = false, evseId = 1) {
				let msgId = randomId();

				saveMsgId('stopTransaction', msgId);

				$('#console').html('');
				seqNo++;
				sessionStorage.setItem('LastAction', "stopTransaction");
				transaction_id == false ? lastTranId = lastTranId : lastTranId = transaction_id;
				
				$('.indicator').hide();
				connector_locked = false;
				logMsg("Connector status changed to: " + connector_locked);
				$('#yellow').show();

				
				var stpT = JSON.stringify([2, msgId, "TransactionEvent", {
					"eventType": "Ended",
					"timestamp": formatDate(new Date()),
					"triggerReason": "Deauthorized",
					"seqNo": seqNo,
					"offline": false,
					/*
					"idToken": {
						//"idToken": $("#TAG option:selected").val(),
						// "idToken":	"SSC_APP_Non99999",
						"idToken":	"1010001083593234",
						//"idToken": "FEDCBA987654321",
						"type": "ISO14443"
					},
					*/
					
					"idToken": {
						"idToken": $("#TAG option:selected").val(),
						"type": "ISO14443"
					},

					"evse": {
						"id": 1, // evseId,
						"connectorId": 1
					},
					"transactionInfo": {
						"transactionId": lastTranId,
						//"remoteStartId": 0
						"stoppedReason": "SOCLimitReached",
						//"stoppedReason": "MasterPass",
						"chargingState": "Idle"
					},
					"meterValue": [{
						"timestamp": formatDate(new Date()),
						"sampledValue": [
							{
								"value": meterVal,
								"context": "Transaction.End"
							},
							{
								"value": soc,
								"measurand": "SoC",
								"context": "Transaction.End"
							},
							{
								"value": 3,		// 0.5
								"measurand": "Current.Import",
								"context": "Sample.Periodic"
							}
						]
					}]
				}]);
				
				/*
				var stpT = JSON.stringify([2, msgId, "TransactionEvent", {
					"eventType":	"Ended",
					"timestamp":	"2024-05-27T15:20:31Z",
					"triggerReason":	"EVCommunicationLost",
					"seqNo":	1234,
					"transactionInfo":	{
						"transactionId":	"123-123",
						"chargingState":	"Idle",
						"stoppedReason":	"EVDisconnected"
					}
				}] );
				*/



				_websocket.send(stpT);
			}

			function getConfiguration() {

			}

			function getCertificateStatus() {
				let msgId = randomId();

				saveMsgId('GetCertificateStatus', msgId);

				sessionStorage.setItem('LastAction', "GetCertificateStatus");

				const ocspData = {
					hashAlgorithm: $('#hashAlgorithm').val() || 'SHA256',
					issuerNameHash: $('#issuerNameHash').val(),
					issuerKeyHash: $('#issuerKeyHash').val(),
					serialNumber: $('#serialNumber').val(),
					responderURL: $('#responderURL').val() || 'www.example.com'
				};

				var GCS = JSON.stringify([2, msgId, "GetCertificateStatus", {
					ocspRequestData: ocspData
				}]);

				_websocket.send(GCS);
			}

			function handleData(data, request = false) {
				var lastAction = getLastAction();
				if (lastAction = "BootNotification") {
					data = data[2];
					heartbeat_interval = data.interval;
					return heartbeat_interval;
				} else if (lastAction = "StartTransaction") {
					return "StartTransaction";
				} else if (1 == 2) {
					alert("else");
				}

			}

			function getLastAction() {
				var LastAction = sessionStorage.getItem("LastAction");
				return LastAction;
			}

			function BootNotification() {
				let msgId = randomId();

				saveMsgId('BootNotification', msgId);

				var BN = JSON.stringify([2, msgId, "BootNotification", {
										
						"chargingStation":{
							"serialNumber":null,
							"model":"AVT-Express",
							"modem":{
								"iccid":"MMCC-IINN-NNNN",
								"imsi":"520031234567890"
							},
							"vendorName":"AVT-Company",
							"firmwareVersion":"0.9.87"
						},
						"reason":"PowerUp"
						


				}]);

				logMsg('ws connected');

				_websocket.send(BN);
			}

			function statusNotification() {
				let msgId = randomId();

				saveMsgId('StatusNotification', msgId);

				sessionStorage.setItem('LastAction', "StatusNotification");
				var SN = JSON.stringify([2, msgId, "StatusNotification", {
					"timestamp": formatDate(new Date()),
					"connectorStatus": $('#status_noti_opt option:selected').val(),
					//"evseId": 1,
					//"connectorId": 2
					"evseId": $('#evse_id').val(),
					"connectorId": $('#conn_id').val()
				}]);
				_websocket.send(SN);
			}

			function meterValues() {
				let msgId = randomId();

				saveMsgId('MeterValues', msgId);

				sessionStorage.setItem('LastAction', "MeterValues");
				var MV = JSON.stringify([2, msgId, "MeterValues", {
					"evseId": 1,
					"meterValue": [{
						"timestamp": formatDate(new Date()),
						"sampledValue": [{
							"value": "0",
							"measurand": "Energy.Active.Import.Register"
						}, {
							"value": "0",
							"measurand": "Energy.Reactive.Import.Register"
						}]
					}, {
						"timestamp": formatDate(new Date()),
						"sampledValue": [{
							"value": "20",
							"measurand": "Energy.Active.Import.Register"
						}, {
							"value": "20",
							"measurand": "Energy.Reactive.Import.Register"
						}]
					}]
				}]);
				_websocket.send(MV);
			}

			function startHB(interval) {
				setInterval(send_heartbeat, interval);
			}

			function send_heartbeat() {
				let msgId = randomId();

				saveMsgId('Heartbeat', msgId);

				sessionStorage.setItem('LastAction', "Heartbeat");
				var HB = JSON.stringify([2, msgId, "Heartbeat", {}]);
				_websocket.send(HB);
			}

			function LogStatusNotification(upload_status = "Uploading") {
				let msgId = randomId();

				saveMsgId('LogStatusNotification', msgId);

				sessionStorage.setItem('LastAction', "LogStatusNotification");
				var LSN = JSON.stringify([2, msgId, "LogStatusNotification", {
					"status": upload_status,
					"requestId": 1,
				}]);
				_websocket.send(LSN);
			}

			function NotifyChargingLimit(charge_limit = 10, limit_source = "SO") {
				let msgId = randomId();

				saveMsgId('NotifyChargingLimit', msgId);

				sessionStorage.setItem('LastAction', "NotifyChargingLimit");
				var LSN = JSON.stringify([2, msgId, "NotifyChargingLimit", {
					"evseId": 1,
					"chargingLimit": {
						"chargingLimitSource": limit_source,
						"isGridCritical": "False",
					},
					"chargingSchedule": charging_schedule(charge_limit)
				}]);
				_websocket.send(LSN);
			}

			function NotifyEVChargingNeeds() {
				let msgId = randomId();

				saveMsgId('NotifyEVChargingNeeds', msgId);

				sessionStorage.setItem('LastAction', "NotifyEVChargingNeeds");
				var LSN = JSON.stringify([2, msgId, "NotifyEVChargingNeeds", {
					"maxScheduleTuples": 3,
					"evseId": 1,
					"chargingNeeds": {
						"requestedEnergyTransfer": "DC",	// AC_single_phase, AC_two_phase, AC_three_phase
						"departureTime": formatDate(new Date()),
						/*
						"acChargingParameters": {
							"energyAmount": 10000,
							"evMinCurrent": 5,
							"evMaxCurrent": 10,
							"evMaxVoltage": 500
						},
						*/
						"dcChargingParameters": {
							"evMaxCurrent": 10,
							"evMaxVoltage": 700,
							"energyAmount": 7000,
							"evMaxPower": 7000,
							"stateOfCharge": 55,
							"evEnergyCapacity": 500,
							"fullSoC": 80,
							"bulkSoC": 80
						}
					}
				}])
					
				_websocket.send(LSN);
			}


			function NotifyEVChargingSchedule(charge_limit = 10, evse_id = 1) {
				let msgId = randomId();

				saveMsgId('NotifyEVChargingSchedule', msgId);

				sessionStorage.setItem('LastAction', "NotifyEVChargingSchedule");
				var NECS = JSON.stringify([2, msgId, "NotifyEVChargingSchedule", {
					"evseId": evse_id,
					"timeBase": formatDate(new Date()),
					"chargingSchedule": charging_schedule(charge_limit)
				}]);
				_websocket.send(NECS);
			}

			function charging_schedule(charge_limit){
				return [
					{
						"id": 11,
						"chargingRateUnit": "A",
						"chargingSchedulePeriod": [
							{
								"startPeriod": 0,
								"limit": charge_limit
							}
						]
					}
				]
			}

			$('#connect').click(function() {
				$('.indicator').hide();
				$('#console').html("");
				wsConnect();
			});

			$('#send').click(function() {
				//for(let i = 0 ; i < 250 ; i++) {
					Authorize();
				//}

			});

			$('#start').click(function() {
				// for(let i = 1 ; i <= 10 ; i++) {
				//	startTransaction("EVConnected", i);
				// }		

				startTransaction("EVConnected");

			});


			$('#remote_start').click(function() {
				remoteStartTransaction();

			});



			$('#update').click(function() {
				updateTransaction();
			});

			$('#update_suspendedev').click(function() {
				updateTransaction(charger_state = "SuspendedEV");
			});

			$('#update_suspendedevse').click(function() {
				updateTransaction(charger_state = "SuspendedEVSE");
			});

			$('#update_charging').click(function() {
				
				/*
				interval = setInterval(() => {
					updateTransaction(charger_state = "Charging");
				}, 5000);			
				*/
				
				updateTransaction(charger_state = "Charging");
			});
			$('#stop').click(function() {
				clearInterval(interval);
				/*
				for(let i = 1 ; i <= 10 ; i++) {
					stopTransaction(true, i);
				}
				*/

				stopTransaction(false);
				
			});

			$('#firmwarestatus').click(function() {
				FirmwareStatusNotification();
			});

			$('#mv').click(function() {
				meterValues();
			});

			$('#heartbeat').click(function() {

				
				// for(let i = 0 ; i < 1000 ; i++) {
					send_heartbeat();
					// statusNotification();
					// Authorize();
				// }
				

			});

			$('#status').click(function() {
				statusNotification();
			});

			$('#data_transfer').click(function() {
				let msgId = randomId();

				saveMsgId('DataTransfer', msgId);

				sessionStorage.setItem('LastAction', "DataTransfer");
				var DT = JSON.stringify([2, msgId, "DataTransfer", {
					"vendorId": "4127003801",
					"messageId": "getPrice.req",
					"data": ""
				}]);
				_websocket.send(DT);

			});

			$('#clearedChargingLimit').click(function() {
				let msgId = randomId();

				saveMsgId('ClearedChargingLimit', msgId);

				sessionStorage.setItem('LastAction', "ClearedChargingLimit");
				var CCL = JSON.stringify([2, msgId, "ClearedChargingLimit", {
					"chargingLimitSource": "Other",
					"evseId": "2"
				}]);
				 _websocket.send(CCL);

			});

			$('#logstatus_uploading').click(function() {
				LogStatusNotification();
			});

			$('#logstatus_uploaded').click(function() {
				LogStatusNotification("Uploaded");
			});

			$('#notify_charging_limit').click(function() {
				NotifyChargingLimit();
			});

			$('#notify_charging_needs').click(function() {
				NotifyEVChargingNeeds()
			})

			$('#notify_ev_charging_schedule').click(function() {
				NotifyEVChargingSchedule();
			});

			$('#security_event_notification').click(function() {
				let msgId = randomId();

				saveMsgId('SecurityEventNotification', msgId);

				sessionStorage.setItem('LastAction', "SecurityEventNotification");
				var SEN = JSON.stringify([2, msgId, "SecurityEventNotification", {
					"type": "FirmwareUpdated",
					"timestamp": formatDate(new Date()),
					"techInfo": "Nothing"
				}]);
				 _websocket.send(SEN);
			})
			

			let csr = '', csrEnd = 0;
			$('#signCert').click(function() {
				let msgId = randomId();

				saveMsgId('SignCertificate', msgId);

				sessionStorage.setItem('LastAction', "SignCertificate");
				var DT = JSON.stringify([2, msgId, "SignCertificate", {
					"csr": csr,
					"certificateType": $('#cert_type option:selected').val()
				}]);
				_websocket.send(DT);
			})

			


			$('#input-csr').change(function(event) {
				let file = event.target.files[0];
		
				let reader = new FileReader();
		
				reader.onload = function(progressEvent) {
					csr = progressEvent.target.result;
					csrEnd = 1;     // ing
				}
		
				reader.readAsText(file);
		
		
				reader.onloadend = function(end) {
					csrEnd = 2;     // end
				}            
			})



			$('#clear_msg').click(function() {
				$('#console').html('');
			});



			$('#connect').on('change', function() {

				if (_websocket) {
					_websocket.close(3001);
				}
			});
			
			$('#getCC').click(function() {
				let msgId = randomId();

				saveMsgId('Get15118EVCertificate', msgId);

				sessionStorage.setItem('LastAction', "Get15118EVCertificate");
				var DT = JSON.stringify([2, msgId, "Get15118EVCertificate", {
					"iso15118SchemaVersion": "urn:iso:15118:2:2013:MsgDef",
      		// iso15118SchemaVersion: 'urn:iso:15118:20:2022:MsgDef',
					"action": "Install",
					"exiRequest": "S01ITFRLWkE2UVZaWE1RVDUwCg=="
					//"exiRequest": "KMHAGDTNPEAJ5PJPR0"
					// "exiRequest": "S01IQUdEVE5QRUFKNVBKUFIw"
				}]);
				_websocket.send(DT);
			})

			$('#GetCertificateStatus').click(getCertificateStatus);
			


		</script>
	</body>
</html>